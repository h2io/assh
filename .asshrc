#!/bin/bash

# prevent loops
[ "$ASSHRC" ] && return || export ASSHRC=true

xv_() {
  sd="$(dirname "${BASH_SOURCE[0]}")"
  xv=$(cat "${sd}/VERSION")
  
  if command -v git >/dev/null 2>&1; then
    xd=$(git -C "$sd" log -1 --format="%cd" --remotes=origin --date=iso-strict 2>/dev/null | xargs -I{} date -u -d "{}" +"%Y-%m-%dT%H:%M:%SZ" || echo "")
    [ -n "$xd" ] && xv="${xv%% *}"
    xs=$(git -C "$sd" rev-parse --short HEAD 2>/dev/null || echo "")
    [ -n "$(git -C "$sd" status --porcelain 2>/dev/null)" ] && xs="$xs-dirty"
  fi
  XV="h2.io/ASSH $xv${xd:+ $xd}${xs:+ $xs}"
}
p+ () {
    local r=""
    IFS=':' read -r -a ps <<< "$1:$2"
    for p in "${ps[@]}"; do
        [[ ":$r:" != *":$p:"* ]] && r="$r:$p"
    done
    echo "${r#:}"
}

# HELP: uses assh by default instead of ssh (use \ssh if you want he original ssh)
alias ssh='assh'

# HELP: grep history
alias ,hg='history|grep'

# HELP: ls ordered, human readable
alias ,ls='ls --human-readable --size -1 -S -F'

# HELP: clean current history
alias ,h0='unset HISTFILE && history -c && history -r ~/.bash_history'

if [ "$XH" ]; then
	# executed via assh login
	[ -r /etc/profile ] && . /etc/profile
	[ -r ~/.bash_profile ] && . ~/.bash_profile ||
	[ -r ~/.bash_login ] && . ~/.bash_login ||
	[ -r ~/.profile ] && . ~/.profile

	export XPATH=$XH:$XH/bin
	#echo "xpath-xh2:$XPATH"
	XL=$XH/lib			# prepare XH libray path to load
	PATH=$(p+ $XPATH $PATH)
fi
if [ "$LH" ]; then
	#echo ".asshrc---if LH"
	export LCHAIN+="+${USER}"
	export LU=${LH%/*}
	#export LD=$(ls -d ${LU}/.assh*/bin 2>/dev/null)
	export LD=$(ls -d ${LU}/.assh*/bin 2>/dev/null| sort -u | tr '\n' ' ')
	#export LF=$(ls -d $LU/.assh*/.asshrc 2>/dev/null | sort | tail -n 1)
	#echo ".asshrc/LU: "$LU
	#echo ".asshrc/LH: "$LH
	#echo ".asshrc/LD: "$LD

	export XV && xv_
	[ -n "$XD" ] && PROMPT_COMMAND=xv_

	# P1: localy sourced from .bashrc (development)
	export LPATH="${LPATH:+$LPATH:}$LH"
	shopt -s nullglob
	for dir in $LD; do
		[[ -d "$dir" ]] || continue  # Skip if not a directory
		LPATH="$LPATH:$dir"
	done

	#LH+="/.assh.d"

	# P2: LH -> XH -> sudo -> LH*
	# TODO: don't always execute (now it doesn't apply it just adds useless path... at best)
	#[[ -d "$LH/bin" ]] && export XPATH="$LH/bin:$XPATH"
	#echo "xpath-P2 :$XPATH"

	: "${XL:=$LH/lib}"		# use LH library path if XH is not present
	PATH=$(p+ $LPATH $PATH)
fi

# load libraries
for file in $XL/*; do
	#echo "file: "$file
	[[ -r "$file" ]] && . "$file"
done

#export LH=${XH:-$LH}
