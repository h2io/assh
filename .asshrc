#!/bin/bash

# prevent loops
[ "$ASSHRC" ] && return || export ASSHRC=true

xv_() {
  sd="$(dirname "${BASH_SOURCE[0]}")"
  xv=$(cat "${sd}/VERSION")
  
  if command -v git >/dev/null 2>&1; then
    xd=$(git -C "$sd" log -1 --format="%cd" --remotes=origin --date=format:"%yw%W.%u" 2>/dev/null || echo "")
    [ -n "$xd" ] && xv="${xv%%-*}"
    xs=$(git -C "$sd" rev-parse --short HEAD 2>/dev/null || echo "")
    [ -n "$(git -C "$sd" status --porcelain 2>/dev/null)" ] && xs="$xs-dirty"
  fi
  XV="h2.io/ASSH $xv${xd:+-$xd}${xs:+-$xs}"
}

# HELP: grep history
alias ,hg='history|grep'

# HELP: ls ordered, human readable
alias ,ls='ls --human-readable --size -1 -S -F'

# HELP: clean current history
alias ,h0='unset HISTFILE && history -c && history -r ~/.bash_history'

if [ "$XH" ]; then
	# executed via assh login
	[ -r /etc/profile ] && . /etc/profile
	[ -r ~/.bash_profile ] && . ~/.bash_profile ||
	[ -r ~/.bash_login ] && . ~/.bash_login ||
	[ -r ~/.profile ] && . ~/.profile

	for file in $XH/lib/*; do
	    [[ -r "$file" ]] && . "$file"
	done
fi
if [ "$LH" ]; then
	export XV && xv_
	[ -n "$XD" ] && PROMPT_COMMAND=xv_

	# executed when sourced localy from .bashrc
	for dir in $(ls -d ~/.assh*/bin 2>/dev/null | sort); do
		[[ -d "$dir" ]] && PATH="$dir:$PATH"
	done
	export PATH=$LH:$PATH

	for file in $LH/lib/*; do
	    [[ -r "$file" ]] && . "$file"
	done
fi

